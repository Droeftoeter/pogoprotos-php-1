<?php
$dir = __DIR__."/src/POGOProtos";

function listFiles($dir) {
  $files = [];
  if ($handle = opendir($dir)) {
    while (false !== ($entry = readdir($handle))) {
      if ($entry != "." && $entry != "..") {
        if (is_dir($dir."/".$entry)) {
          $files = array_merge($files, listFiles($dir."/".$entry));
        }
        else {
          $files[] = $dir."/".$entry;
        }
      }
    }
    closedir($handle);
  }

  return $files;
}

function patchFile($file) {
  $lines = file($file);
  if (!is_array($lines)) {
    echo "Unable to patch ".$file." - can't read\n";
    return false;
  }
  $lines[1] = "// Generated by https://github.com/bramp/protoc-gen-php";
  unset($lines[2]);
  unset($lines[3]);

  foreach ($lines as $n => $line) {
    if (preg_match("/require\('(.*).proto.php'\);/i", $line, $match)) {
      unset($lines[$n]);
    }
  }

  if (file_put_contents(str_replace(".proto.php", ".php", $file), implode("", $lines)) === false) {
    echo "Unable to patch ".$file." - can't write\n";
    return false;
  }

  if (!unlink($file)) {
    echo "Unable to patch ".$file." - can't delete original\n";
    return false;
  }

  echo "Patched ".$file."\n";
  return true;
}

$files = listFiles($dir);

$count = 0;

foreach ($files as $file) {
  if (preg_match("/.proto.php$/", $file)) {
    if (patchFile($file)) {
      $count++;
    }
  }
}

echo "\nPATCHED ".$count." FILES\n";
